<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Log Viewer</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
}

.glass{
  background:rgba(255,255,255,0.15);
  backdrop-filter:blur(15px);
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.3);
  box-shadow:0 8px 32px rgba(0,0,0,0.2);
  color:white;
}

.table td,.table th{
  color:black;
}

.warning{
  background-color:#fff3cd !important;
}

.danger{
  background-color:#f8d7da !important;
  animation: pulse 1.5s infinite;
}

@keyframes pulse{
  0%{opacity:1;}
  50%{opacity:0.7;}
  100%{opacity:1;}
}
</style>
</head>

<body>

<nav class="navbar navbar-expand-lg glass m-3 px-4">
  <a class="navbar-brand text-white fw-bold" href="#">Env Monitor</a>
  <div class="ms-auto">
    <a href="index.html" class="btn btn-outline-light me-2">Dashboard</a>
    <a href="logs.html" class="btn btn-outline-light">Logs</a>
  </div>
</nav>

<div class="container">
<div class="glass p-4">

<h4 class="mb-3">Filter by Date</h4>

<div class="d-flex gap-3 mb-4">
  <input type="date" id="datePicker" class="form-control w-auto">
  <button id="exportBtn" class="btn btn-success">Export CSV</button>
</div>

<div class="table-responsive">
<table class="table table-hover">
<thead>
<tr>
<th>Time</th>
<th>Temp (Â°C)</th>
<th>Humidity (%)</th>
<th>PM2.5 (Âµg/mÂ³)</th>
<th>PM10 (Âµg/mÂ³)</th>
<th>Gas (MQ2)</th> <!-- â­ à¹€à¸žà¸´à¹ˆà¸¡ -->
<th>Status</th>
</tr>
</thead>
<tbody id="logTable"></tbody>
</table>
</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, query, onValue, limitToLast } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "pj-smoke-part-2.firebaseapp.com",
  databaseURL: "https://pj-smoke-part-2-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "pj-smoke-part-2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let fullData = [];

function formatDate(timestamp){

  const date = new Date(timestamp * 1000);

  const options = {
    timeZone: "Asia/Bangkok",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  };

  const formatted = new Intl.DateTimeFormat("en-GB", options).format(date);
  const [day, month, rest] = formatted.split("/");
  const [year, time] = rest.split(", ");

  return {
    display: `${day}/${month}/${year} ${time}`,
    iso: `${year}-${month}-${day}`
  };
}

/* â­ à¹€à¸žà¸´à¹ˆà¸¡ gas à¹€à¸‚à¹‰à¸² logic */
function getStatus(pm25, pm10, gas){

  if(pm25 > 75 || pm10 > 150 || gas > 600)
    return {text:"ðŸš¨ Danger", class:"danger"};

  else if(pm25 > 25 || pm10 > 50 || gas > 400)
    return {text:"âš ï¸ Warning", class:"warning"};

  else
    return {text:"âœ… Safe", class:""};
}

const logQuery = query(ref(db,"envLogs"), limitToLast(500));

onValue(logQuery, (snapshot)=>{

  fullData = [];

  snapshot.forEach(child=>{
    fullData.push(child.val());
  });

  renderTable();
});

function renderTable(){

  const selectedDate = document.getElementById("datePicker").value;
  const table = document.getElementById("logTable");
  table.innerHTML = "";

  const fragment = document.createDocumentFragment();

  fullData
  .sort((a,b)=>b.timestamp-a.timestamp)
  .forEach(d=>{

    const dateInfo = formatDate(d.timestamp);

    if(selectedDate && dateInfo.iso !== selectedDate) return;

    const status = getStatus(d.pm25, d.pm10, d.gas);

    const row = document.createElement("tr");

    if(status.class !== ""){
      row.classList.add(status.class);
    }

    row.innerHTML = `
      <td>${dateInfo.display}</td>
      <td>${d.temperature.toFixed(2)}</td>
      <td>${d.humidity.toFixed(2)}</td>
      <td>${d.pm25}</td>
      <td>${d.pm10}</td>
      <td>${d.gas ?? "-"}</td>  <!-- â­ à¹à¸ªà¸”à¸‡ gas -->
      <td><strong>${status.text}</strong></td>
    `;

    fragment.appendChild(row);
  });

  table.appendChild(fragment);
}

document.getElementById("datePicker")
.addEventListener("change", renderTable);

document.getElementById("exportBtn")
.addEventListener("click", ()=>{

  const selectedDate = document.getElementById("datePicker").value;

  if(!selectedDate){
    alert("Please select a date first");
    return;
  }

  let csv = "Time,Temperature (Â°C),Humidity (%),PM2.5 (Âµg/mÂ³),PM10 (Âµg/mÂ³),Gas (MQ2)\n";

  fullData.forEach(d=>{
    const dateInfo = formatDate(d.timestamp);

    if(dateInfo.iso === selectedDate){
      csv += `${dateInfo.display},${d.temperature},${d.humidity},${d.pm25},${d.pm10},${d.gas}\n`;
    }
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `env_log_${selectedDate}.csv`;
  a.click();
});
</script>

</body>
</html>